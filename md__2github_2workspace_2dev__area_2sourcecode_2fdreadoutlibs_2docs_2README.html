<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: fdreadoutlibs - Far Detector readout libraries</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">fdreadoutlibs - Far Detector readout libraries</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md308"></a>Collection of Far Detector FrontEnd specific readout specializations. This includes type definitions to be used with the implementations in <code>readoutlibs</code> and frontend specific specializations (i.e. frame processors or software hit finding). It is the glue between <code>readoutlibs</code> and <code>readoutmodules</code> that specifies types and implementations for the use of <code>readoutlibs</code> that can then be imported by <code>fdreadoutmodules</code> to be initialized in the <code>DataLinkHandler</code> module.</p>
<h1><a class="anchor" id="autotoc_md309"></a>
Building and setting up the workarea</h1>
<p>How to clone and build DUNE DAQ packages, including <code>readout</code>, is covered in <a href="https://dune-daq-sw.readthedocs.io/en/latest/packages/daq-buildtools/">the daq-buildtools instructions</a>. For examples on how to run the standalone readout app, take a look at the <code>fdreadoutmodules</code> documentation.</p>
<h1><a class="anchor" id="autotoc_md310"></a>
Frontends and features provided by &lt;tt&gt;fdreadoutlibs&lt;/tt&gt;</h1>
<p>The following frontends and features are provided by this package:</p><ul>
<li><em>Daphne</em>: Frame processor and request handler to be used with the SkipList latency buffer.</li>
<li><em>SSP</em>: Only frame processor</li>
<li><em>WIB</em>: Frame processor for <code>WIB</code>, software and hardware <code>WIB</code> TPs. Implementation of avx based software hit finding (software tpg) for <code>WIB</code></li>
<li><em>WIB2</em>: Frame processor for <code>WIB2</code>, implementation of avx based software hit finding (software tpg) for <code>WIB2</code></li>
<li><em>WIBETH</em>: Frame processor for <code>WIBETH</code>, implementation of avx based software hit finding (software tpg) for <code>WIBETH</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md311"></a>
TPG Applications</h1>
<p>Here is a short summary of the applications and scripts available in <code>fdreadoutlibs</code>. Refer to the code for further details.</p>
<h2><a class="anchor" id="autotoc_md312"></a>
Emulator</h2>
<p><code>wibeth_tpg_algorithms_emulator</code> is a emulator for validating different TPG algorithms, either in a naive or in AVX implementation. The application allows to emulate the workload when running a TPG algorithm and therefore monitor performance metrics. It requires an input binary frame file (check assets-list for valid input files) and it will execute the desired TPG algorithm for a configurable duration (default value is 120 seconds). The application is single threaded, pinned to core 0.</p>
<p>To use the tool use the following: </p><div class="fragment"><div class="line">$ wibeth_tpg_algorithms_emualator --help </div>
<div class="line">Test TPG algorithms</div>
<div class="line">Usage: wibeth_tpg_algorithms_emulator [OPTIONS]</div>
<div class="line"> </div>
<div class="line">Options:</div>
<div class="line">  -h,--help                   Print this help message and exit</div>
<div class="line">  -f,--frame-file-path TEXT   Path to the input frame file</div>
<div class="line">  -a,--algorithm TEXT         TPG Algorithm (SimpleThreshold / AbsRS)</div>
<div class="line">  -i,--implementation TEXT    TPG implementation (AVX / NAIVE)</div>
<div class="line">  -d,--duration-test INT      Duration (in seconds) to run the test</div>
<div class="line">  -n,--num-frames-to-read INT Number of frames to read. Default: select all frames.</div>
<div class="line">  -t,--tpg-threshold INT      Value of the TPG threshold</div>
<div class="line">  --save-adc-data             Save ADC data</div>
<div class="line">  --save-trigprim             Save trigger primitive data</div>
</div><!-- fragment --><p>The command line option <code>save_adc_data</code> allows to save the raw ADC values in a txt file after the 14-bit to 16-bit expansion. The command line option <code>save_trigprim</code> allows to save the in a file the Trigger Primitive object information in a txt file.</p>
<p>Example of usage: </p><div class="fragment"><div class="line">$ wibeth_tpg_algorithms_emulator --frame_file_path FRAMES_FILE --algorithm SimpleThreshold --implementation AVX --save_adc_data</div>
<div class="line">$ wibeth_tpg_algorithms_emulator --frame_file_path FRAMES_FILE --algorithm AbsRS --implementation AVX  --save_trigprim </div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md313"></a>
Utility tools and scripts</h2>
<ul>
<li><code>wibeth_binary_frame_reader</code>: reads a WIBEth frame file (<code>.bin</code> file) and prints all the ADC values on screen. Usage <code>wibeth_binary_frame_reader &lt;input_file_name&gt;</code>. <br  />
</li>
<li><code>wibeth_binary_frame_modifier</code> is used to create a custom WIBEth frame file suitable for testing different patterns. The application will produce an output file <code>wibeth_output.bin</code>. There are no command line options, please refer to the code for further details (e.g. what ADC value to set, which time frame to use, etc.).</li>
<li><code>plot_trigprim_output_data.py.py</code> plots the Trigger Primitive output file obtained through <code>wibeth_tpg_algorithms_emulator</code> (when <code>save_trigprim</code> flag is enabled) and produces a plot called <code>output_trigger_primitives.png</code> . This script requires the use of <code>matplotlib</code>. To use the script run the following command: <div class="fragment"><div class="line">python3 plot_trigprim_output_data.py  -f TP_OUTPUT.TXT</div>
</div><!-- fragment --></li>
</ul>
<h4><a class="anchor" id="autotoc_md314"></a>
Setup matplotlib on NP04 machines (e.g. &lt;tt&gt;np04-srv-019&lt;/tt&gt;)</h4>
<p>To use the <code>matplotlib</code> python module run the following command on a console where the DUNE-DAQ software area has not been sourced: </p><div class="fragment"><div class="line">pip install --prefix=$PREFIX_PATH matplotlib</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md315"></a>
Validation</h1>
<h2><a class="anchor" id="autotoc_md316"></a>
Pattern Generation App</h2>
<p>There is a separate application in the <code>apps</code> directory tailored to WIBEth pattern generation. It shares common features with <code>wibeth_tpg_algorithms_emulator</code>.</p>
<p>Before running the pattern generation app, please make sure you have downloaded an existing WIBEth binary file from the asset repository, e.g.,</p>
<div class="fragment"><div class="line">&gt; assets-list  --subsystem readout</div>
<div class="line">dd156b4895f1b06a06b6ff38e37bd798 readout         WIBEth          valid           /cvmfs/dunedaq.opensciencegrid.org/assets/files/d/d/1/wibeth_output_all_zeros.bin</div>
<div class="line">&gt; cp /cvmfs/dunedaq.opensciencegrid.org/assets/files/d/d/1/wibeth_output_all_zeros.bin . </div>
</div><!-- fragment --><p> The <code>wibeth_output_all_zeros.bin</code> file contains 32 WIBEth frames with all ADC values set to 0. Each frame corresponds to 64 channels and 64 clock-ticks. It is convenient to consider each word in the frame as 64 bits long. The frame header, among other information, contains the 64b timestamp value in the 2nd header word. The difference between the timestamps of every two consecutive WIBEth frames is 2048 (i.e., 64 clock-ticks per frame * 32 units per clock-tick = 2048).</p>
<p>Currently the TPs stored in text files contain the following hit parameters, e.g. </p><div class="fragment"><div class="line">channel,time_start,time_over_threshold,time_peak,adc_integral,adc_peak,type</div>
<div class="line">0,79554162068719975,256,79554162068720103,4528,506</div>
<div class="line">0,79554162068722023,224,79554162068722151,4021,505</div>
</div><!-- fragment --><p>Then we can proceed to the pattern generation step.</p>
<div class="fragment"><div class="line">wibeth_tpg_pattern_generator -h</div>
</div><!-- fragment --><p>Examples:</p>
<ol type="1">
<li>Generate binary file containing the selected pattern <div class="fragment"><div class="line">wibeth_tpg_pattern_generator -f wibeth_output_all_zeros.bin -n 2 -i 0 -t 499 -o 1 -p patt_golden</div>
</div><!-- fragment --></li>
<li>In addition to 1., store the hits (currently in a text file) contained in generated binary file <div class="fragment"><div class="line">wibeth_tpg_pattern_generator -f patt_input.bin -n 2 -i 0 -t 499 -o 1 -p patt_golden --save-trigprim</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md317"></a>
TPG Algorithm Validation</h2>
<p>There is a Python script in the <code>scripts</code> directory to compare hits found by the AVX and NAIVE implementations of the TPG algorithm.</p>
<div class="fragment"><div class="line">python sourcecode/fdreadoutlibs/scripts/compare_avx_vs_naive.py -h</div>
</div><!-- fragment --><p> Example:</p>
<div class="fragment"><div class="line">python sourcecode/fdreadoutlibs/scripts/compare_avx_vs_naive.py . -n test_01</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md318"></a>
Test Patterns</h2>
<p>This section describes the available patterns. Currently the following patterns are implemented.</p>
<ol type="1">
<li>Golden - most complicated pattern so far.</li>
<li>Pulse - Single pulse on a single channel and single time tick.</li>
<li>Edge square - a square pulse on the edge between two WIBEth frames.</li>
<li>Edge left - a triangular pulse spanning two frames where the hit peak is in the first (left-side) frame.</li>
<li>Edge reight - same as 4. but the hit peak is in the the second (right-side) frame.</li>
</ol>
<h3><a class="anchor" id="autotoc_md319"></a>
Here is a description of the so-called "golden" pattern.</h3>
<p>In every frame, one hit is generated and placed in the selected channel. In every binary file, the hit start time can be offset by the specified number of clock-ticks. The time tick offset value is attached to the name of the output binary file, e.g. <code>patt_golden_35_wibeth_output.bin</code>. <br  />
</p>
<p>The hit ADC values and the hit parameters are (before pedestal substraction): </p><div class="fragment"><div class="line">ADC values               : 500 502 504 505 506 505 504 502 500</div>
<div class="line">ts_0                     : initial timestamp from the first frame of the binary file</div>
<div class="line">ts_hit_offset            : hit start clock-tick, varies from 1 to 63  </div>
<div class="line">hit finder threshold     : 499   (recommended)</div>
<div class="line">hit time-over-threshold  : 8 * 32 = 256 (clock-ticks, counted from 0)</div>
<div class="line">hit peak_time            : ts_0  + (time_offset + 4) * 32  e.g.  79554162068719943 + (1 + 4) * 32</div>
<div class="line">hit peak_adc             : 506</div>
<div class="line">hit sum_adc              : 4528</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md320"></a>
Notes</h2>
<ul>
<li>The tools and scripts developed have been used for TPG related activities. They have not been generalized to cover all use-cases. If there is a need or feature request, ask mainteners of the repository. <br  />
</li>
<li>The repository also contains tools for WIB2 frames but they are not kept up to date. Please refer to the code or ask mainteners of the repository for help. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
