<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DUNE-DAQ: readoutmodules - Readout plugin collection</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">DUNE-DAQ
   </div>
   <div id="projectbrief">DUNE Trigger and Data Acquisition software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">readoutmodules - Readout plugin collection</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md198"></a>Collection of readout specializations. </p>
<h1><a class="anchor" id="autotoc_md199"></a>
Building and setting up the workarea</h1>
<p>How to clone and build DUNE DAQ packages, including <code>readoutmodules</code>, is covered in <a href="https://dune-daq-sw.readthedocs.io/en/latest/packages/daq-buildtools/">the daq-buildtools instructions</a>. You should follow these steps to set up your workarea that you can then use to run the following examples.</p>
<h1><a class="anchor" id="autotoc_md200"></a>
Examples</h1>
<p>Before running the application, please download a small binary file that contains WIB Frames from the following <a href="https://cernbox.cern.ch/index.php/s/7qNnuxD8igDOVJT">CERNBox link</a>, or from the commandline: </p><pre class="fragment">curl https://cernbox.cern.ch/index.php/s/0XzhExSIMQJUsp0/download -o frames.bin
</pre><p> For WIB2 frames, download the following file that contains 120 WIB-2 Frames from the following <a href="https://cernbox.cern.ch/index.php/s/ocrHxSU8PucxphE">CERNBox link</a>, or like so: </p><pre class="fragment">curl https://cernbox.cern.ch/index.php/s/ocrHxSU8PucxphE/download -o wib2-frames.bin
</pre><p> If you download it to a different destination, please update the path of the source file in the configuration that you will use below.</p>
<p>To run a standalone readout app (instructions for the complete minidaqapp are included in the setup instructions above), you first create a config with: </p><pre class="fragment">python -m readoutmodules.app_confgen -n 2 app.json
</pre><p> Here, we use a fake card emulator with two WIB links. More options can be viewed with <code>-h</code>. Then, start the application with </p><pre class="fragment">daq_application -c stdin://app.json -n test
</pre><p> You can now issue commands by typing them and pressing enter. Issue the commands <code>init</code>, <code>conf</code> and then <code>start</code>. You will see some json output from the operational monitoring every 10 seconds.</p>
<h1><a class="anchor" id="autotoc_md201"></a>
Enabling the Software TPG</h1>
<p>To enable the SIMD accelerated software hit finding, one can use raw data recorded from ProtoDUNE-SP to get meaningful hits. A subset of these raw files can be found under: </p><pre class="fragment">/eos/experiment/neutplatform/protodune/rawdata/np04/protodune-sp/raw/2020/detector/test/None/02/00/00/01/
</pre><p> For single link tests, a good link file can be: </p><pre class="fragment">/eos/experiment/neutplatform/protodune/rawdata/np04/protodune-sp/raw/2020/detector/test/None/02/00/00/01/felix-2020-06-02-093338.0.0.0.bin
</pre><p> The produced hit rate should be around 100kHz.</p>
<h1><a class="anchor" id="autotoc_md202"></a>
Enabling the fake TP source</h1>
<p>The FakeCardReader module is capable of reading raw WIB2 TP data by enabling the corresponding link via configuration. In emulator mode, the fake TPs are read out from a binary file (with default location at ./tp_frames.bin) and parsed using the "RawTp" format <code>detdataformats</code>.</p>
<p>To get the "tp_frames.bin" TP data: </p><pre class="fragment">curl https://cernbox.cern.ch/index.php/s/FqMXxSpM3WjgeCN/download -o tp_frames.bin
</pre><p> _Instructions on how to test the fake raw WIB TP readout will be provided/updated here:</p>
<p>Testing TP standalone configuration script with dunedaq-v3.1.0:</p>
<ol type="1">
<li>Download tp_frames.bin file <div class="fragment"><div class="line">curl https://cernbox.cern.ch/index.php/s/FqMXxSpM3WjgeCN/download -o tp_frames.bin</div>
</div><!-- fragment --></li>
<li>Setup v3.1.0 work area and checkout branch <div class="fragment"><div class="line">git clone https://github.com/DUNE-DAQ/readoutmodules.git -b hristova/tp_appconfgen_fix</div>
<div class="line">dbt-build -j16</div>
</div><!-- fragment --></li>
<li>Check TP standalone configuration script was installed <div class="fragment"><div class="line">find . -name readoutapp_gen -type f -print</div>
<div class="line">readoutapp_gen -h</div>
</div><!-- fragment --></li>
<li>Generate configuration (TP links only, WIB2 format)</li>
</ol>
<p>4a. WIB2 </p><div class="fragment"><div class="line">readoutapp_gen -n 0 -t 1 -c 2048 -m VDColdboxChannelMap tpapp.json</div>
</div><!-- fragment --><p> 4b. WIB1 (currently default) </p><div class="fragment"><div class="line">readoutapp_gen -n 0 -t 1 tpapp.json</div>
</div><!-- fragment --><ol type="1">
<li>Run test job with nanorc <div class="fragment"><div class="line">rm -Rf RunConf_1; nanorc tpapp.json test boot conf start_run 001 wait 10 stop_run scrap terminate</div>
</div><!-- fragment --></li>
</ol>
<p>The fix in branch <a href="https://github.com/DUNE-DAQ/readoutmodules/tree/hristova/tp_appconfgen_fix">https://github.com/DUNE-DAQ/readoutmodules/tree/hristova/tp_appconfgen_fix</a> allows the WIB2 configuration options to be used.</p>
<h1><a class="anchor" id="autotoc_md203"></a>
Modules provided by readoutmodules</h1>
<p><code>readoutmodules</code> provides several <code>DAQModule</code>s that are listed here:</p><ul>
<li><code>DataLinkHandler</code>: Abstraction for one link of the DAQ. It receives input from a frontend as raw data and buffers it in memory. Data can be retrieved through a request/response mechanism (requests are of the type <code>DataRequest</code> and the response is a <code>Fragment</code>). Additionaly, data can be recorded for a specified amount of time and written to disk through a high performance mechanism. The module can handle different frontends and some support additional features. For example, for WIB, software tpg is available and can be enabled. For more details, consult the <code>readoutlibs</code> repo that defines and implements a <code>ReadoutModel</code>, which this module wraps.</li>
<li><code>FakeCardReader</code>: This module emulates a frontend that pushes raw data to a <code>DataLinkHandler</code> by reading raw data from a file and repeating it over and over, while updating the timestamps of the data. A slowdown factor can be set to run at a lower speed which makes it possible to run the whole DAQ on less powerful systems.</li>
<li><code>DataRecorder</code>: Receives data from an input queue and writes it to disk. It supports writing with <code>O_DIRECT</code>, making it more performant in some scenarios.</li>
<li><code>FragmentConsumer</code>: Consumes fragments and does some sanity checks of the data (for now just for WIB data) like checking the timestamps of the data against the requested window.</li>
<li><code>ErroredFrameConsumer</code>: Consumes error frames, this module is used as long as there is no other consumer for this information.</li>
<li><code>TimeSyncConsumer</code>: Consumes timesync messages (and nothing more). Can be used in the standalone readout app. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
